#!/usr/bin/env node

import fs from 'fs';
import path from 'path';
import { fileURLToPath } from 'url';
import snarkjs from 'snarkjs';

const __dirname = path.dirname(fileURLToPath(import.meta.url));
const CIRCUITS_ROOT = path.join(__dirname, '..');
const CONTRACTS_ROOT = path.join(CIRCUITS_ROOT, '..', 'contracts');
const CIRCOMKIT_CONFIG = path.join(CIRCUITS_ROOT, 'circomkit.json');

const circuitName = process.argv[2] || 'shadow';
const buildDir = path.join(CIRCUITS_ROOT, 'build', circuitName);
const zkeyPath = path.join(buildDir, `${circuitName}.zkey`);
const contractName = `${capitalize(circuitName)}Verifier`;
const artifactsDir = path.join(CIRCUITS_ROOT, 'artifacts');
const artifactPath = path.join(artifactsDir, `${contractName}.sol`);
const contractsPath = path.join(CONTRACTS_ROOT, 'src', `${contractName}.sol`);

async function main() {
  const config = JSON.parse(fs.readFileSync(CIRCOMKIT_CONFIG, 'utf8'));
  if (String(config.protocol || '').toLowerCase() !== 'plonk') {
    console.error(
      "Unsupported proving protocol in circomkit.json. Verifier generation is PLONK-only in this repo."
    );
    process.exit(1);
  }

  if (!fs.existsSync(zkeyPath)) {
    console.error(`Error: ${zkeyPath} not found. Run 'pnpm setup:plonk' first.`);
    process.exit(1);
  }

  fs.mkdirSync(artifactsDir, { recursive: true });
  fs.mkdirSync(path.dirname(contractsPath), { recursive: true });

  console.log(`Generating ${contractName} from ${zkeyPath}`);
  const verifierCode = await snarkjs.zKey.exportSolidityVerifier(zkeyPath);
  const finalCode = formatVerifier(verifierCode, circuitName);

  fs.writeFileSync(artifactPath, finalCode);
  fs.writeFileSync(contractsPath, finalCode);

  console.log(`Verifier written to ${artifactPath}`);
  console.log(`Verifier copied to ${contractsPath}`);
}

function formatVerifier(code, circuit) {
  const header = `// SPDX-License-Identifier: MIT\n// Generated by snarkjs - DO NOT EDIT\n// Circuit: ${capitalize(circuit)} (PLONK)\n/// @custom:security-contact security@taiko.xyz\n\n`;
  return header + code;
}

function capitalize(str) {
  return str.charAt(0).toUpperCase() + str.slice(1);
}

main().catch((err) => {
  console.error('Verifier generation failed:', err);
  process.exit(1);
});
